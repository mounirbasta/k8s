name: Verify App Deployment Health

on:
  push:
    branches: [ "main" ]
    paths:
      - 'deployments/app-deployment.yaml'

env:
  ARGOCD_APP_NAME: app-dev
  APP_NAMESPACE: app-dev
  APP_DEPLOYMENT: app
  HEALTH_CHECK_TIMEOUT: 300
  HEALTH_CHECK_INTERVAL: 15

jobs:
  verify-and-rollback:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup ArgoCD CLI
        uses: clowdhaus/argo-cd-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: version
          options: --client
      
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          argocd login $ARGOCD_SERVER \
            --username $ARGOCD_USERNAME \
            --password $ARGOCD_PASSWORD \
            --grpc-web --insecure
      
      - name: Sync app with prune
        run: |
          echo "Syncing app with prune to ensure clean state..."
          argocd app sync ${{ env.ARGOCD_APP_NAME }} --prune --force
          
          echo "Waiting for sync to complete..."
          sleep 10
      
      - name: Monitor app deployment health
        id: health_check
        run: |
          echo "Monitoring deployment: ${{ env.APP_DEPLOYMENT }} in namespace: ${{ env.APP_NAMESPACE }}"
          echo "Checking for up to ${{ env.HEALTH_CHECK_TIMEOUT }} seconds..."
          
          ELAPSED=0
          while [ $ELAPSED -lt ${{ env.HEALTH_CHECK_TIMEOUT }} ]; do
            # Get deployment resource info
            APP_JSON=$(argocd app get ${{ env.ARGOCD_APP_NAME }} -o json)
            
            DEPLOYMENT_INFO=$(echo "$APP_JSON" | jq -r '
              .status.resources[] | 
              select(.kind == "Deployment" and .name == "'"${{ env.APP_DEPLOYMENT }}"'" and .namespace == "'"${{ env.APP_NAMESPACE }}"'")
            ')
            
            DEPLOYMENT_HEALTH=$(echo "$DEPLOYMENT_INFO" | jq -r '.health.status // "Unknown"')
            DEPLOYMENT_MESSAGE=$(echo "$DEPLOYMENT_INFO" | jq -r '.health.message // "No message"')
            REQUIRES_PRUNING=$(echo "$DEPLOYMENT_INFO" | jq -r '.requiresPruning // false')
            
            echo "[$ELAPSED s] Health: $DEPLOYMENT_HEALTH | Requires Pruning: $REQUIRES_PRUNING"
            
            if [ "$DEPLOYMENT_MESSAGE" != "No message" ]; then
              echo "  Message: $DEPLOYMENT_MESSAGE"
            fi
            
            # Check for FAILURE conditions
            if [ "$DEPLOYMENT_HEALTH" = "Degraded" ]; then
              echo "::error::Deployment is Degraded!"
              echo "Message: $DEPLOYMENT_MESSAGE"
              argocd app get ${{ env.ARGOCD_APP_NAME }} \
                --resource apps:Deployment:${{ env.APP_NAMESPACE }}/${{ env.APP_DEPLOYMENT }}
              echo "deployment_failed=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            if [ "$DEPLOYMENT_HEALTH" = "Missing" ]; then
              echo "::error::Deployment is Missing!"
              echo "deployment_failed=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # Check for SUCCESS
            # Primary success: Deployment is Healthy
            if [ "$DEPLOYMENT_HEALTH" = "Healthy" ]; then
              echo "Deployment is Healthy!"
              
              # Warn if pruning needed but don't fail
              if [ "$REQUIRES_PRUNING" = "true" ]; then
                echo "Note: Some resources require pruning (will be cleaned up by ArgoCD)"
              fi
              
              echo "deployment_failed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Still progressing
            if [ "$DEPLOYMENT_HEALTH" = "Progressing" ]; then
              echo "  Deployment is progressing..."
            fi
            
            # Unknown health - wait a bit more
            if [ "$DEPLOYMENT_HEALTH" = "Unknown" ]; then
              echo "  Health status is still Unknown..."
            fi
            
            sleep ${{ env.HEALTH_CHECK_INTERVAL }}
            ELAPSED=$((ELAPSED + ${{ env.HEALTH_CHECK_INTERVAL }}))
          done
          
          # Timeout reached
          APP_JSON=$(argocd app get ${{ env.ARGOCD_APP_NAME }} -o json)
          FINAL_HEALTH=$(echo "$APP_JSON" | jq -r '
            .status.resources[] | 
            select(.kind == "Deployment" and .name == "'"${{ env.APP_DEPLOYMENT }}"'" and .namespace == "'"${{ env.APP_NAMESPACE }}"'") |
            .health.status // "Unknown"
          ')
          
          echo "::error::Timeout after ${{ env.HEALTH_CHECK_TIMEOUT }}s"
          echo "Final health status: $FINAL_HEALTH"
          
          argocd app get ${{ env.ARGOCD_APP_NAME }} \
            --resource apps:Deployment:${{ env.APP_NAMESPACE }}/${{ env.APP_DEPLOYMENT }}
          
          echo "deployment_failed=true" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Show deployment details on failure
        if: failure() && steps.health_check.outputs.deployment_failed == 'true'
        run: |
          echo "=== Full Deployment Resource Status ==="
          argocd app get ${{ env.ARGOCD_APP_NAME }} \
            --resource apps:Deployment:${{ env.APP_NAMESPACE }}/${{ env.APP_DEPLOYMENT }} \
            --show-operation
          
          echo ""
          echo "=== Resources Requiring Pruning ==="
          argocd app get ${{ env.ARGOCD_APP_NAME }} -o json | jq -r '
            .status.resources[] | 
            select(.requiresPruning == true) |
            "\(.kind)/\(.name) in \(.namespace)"
          '
          
          echo ""
          echo "=== All app-dev Resources ==="
          argocd app get ${{ env.ARGOCD_APP_NAME }} -o json | jq -r '
            .status.resources[] | 
            select(.namespace == "'"${{ env.APP_NAMESPACE }}"'") |
            "\(.kind)/\(.name): Health=\(.health.status // "N/A") Sync=\(.status)"
          '
      
      - name: Rollback on failure
        if: failure() && steps.health_check.outputs.deployment_failed == 'true'
        run: |
          echo "Deployment health check failed - rolling back Git commit..."
          
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BAD_COMMIT=$(git rev-parse HEAD)
          echo "Rolling back commit: $BAD_COMMIT"
          
          # Check if merge commit
          PARENT_COUNT=$(git cat-file -p HEAD | grep "^parent" | wc -l)
          
          if [ "$PARENT_COUNT" -gt 1 ]; then
            echo "Merge commit - reverting with mainline 1"
            git revert HEAD --no-edit -m 1
            git push origin main
          else
            echo "Regular commit - using reset"
            git reset --hard HEAD~1
            git push origin main --force-with-lease
          fi
          
          echo "Git rollback completed"
          
          # Trigger sync after rollback
          echo "Syncing ArgoCD to rolled-back version..."
          argocd app sync ${{ env.ARGOCD_APP_NAME }} --prune --force
          
          sleep 30
          
          # Verify rollback
          echo "Checking deployment health after rollback..."
          ROLLED_BACK_HEALTH=$(argocd app get ${{ env.ARGOCD_APP_NAME }} -o json | jq -r '
            .status.resources[] | 
            select(.kind == "Deployment" and .name == "'"${{ env.APP_DEPLOYMENT }}"'" and .namespace == "'"${{ env.APP_NAMESPACE }}"'") |
            .health.status // "Unknown"
          ')
          echo "Post-rollback health: $ROLLED_BACK_HEALTH"
      
      - name: Notify on success
        if: success()
        run: |
          echo "::notice::Deployment verified successfully - ${{ env.APP_DEPLOYMENT }} is healthy"
