name: Verify Deployment Health

on:
  push:
    branches: [ "main" ]
    paths:
      - 'deployments/app-deployment.yaml'

env:
  ARGOCD_APP_NAME: app-dev
  HEALTH_CHECK_TIMEOUT: 300  # 5 minutes in seconds
  HEALTH_CHECK_INTERVAL: 15   # Check every 15 seconds

jobs:
  verify-and-rollback:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup ArgoCD CLI
        uses: clowdhaus/argo-cd-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: version
          options: --client
      
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          argocd login $ARGOCD_SERVER \
            --username $ARGOCD_USERNAME \
            --password $ARGOCD_PASSWORD \
            --grpc-web --insecure
      
      - name: Trigger sync
        run: |
          echo "Triggering ArgoCD sync..."
          argocd app sync ${{ env.ARGOCD_APP_NAME }} --prune
      
      - name: Wait and check health
        id: health_check
        run: |
          echo "Monitoring deployment health for up to ${{ env.HEALTH_CHECK_TIMEOUT }} seconds..."
          
          ELAPSED=0
          while [ $ELAPSED -lt ${{ env.HEALTH_CHECK_TIMEOUT }} ]; do
            # Get app status
            APP_JSON=$(argocd app get ${{ env.ARGOCD_APP_NAME }} -o json)
            
            HEALTH=$(echo "$APP_JSON" | jq -r '.status.health.status')
            SYNC=$(echo "$APP_JSON" | jq -r '.status.sync.status')
            
            echo "[$ELAPSED s] Health: $HEALTH | Sync: $SYNC"
            
            # Check for failure conditions
            if [ "$HEALTH" = "Degraded" ]; then
              echo "::error::Deployment health is Degraded"
              argocd app get ${{ env.ARGOCD_APP_NAME }}
              echo "deployment_failed=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            if [ "$HEALTH" = "Missing" ]; then
              echo "::error::Deployment resources are Missing"
              argocd app get ${{ env.ARGOCD_APP_NAME }}
              echo "deployment_failed=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # Check for success
            if [ "$HEALTH" = "Healthy" ] && [ "$SYNC" = "Synced" ]; then
              echo "Deployment successful!"
              echo "deployment_failed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep ${{ env.HEALTH_CHECK_INTERVAL }}
            ELAPSED=$((ELAPSED + ${{ env.HEALTH_CHECK_INTERVAL }}))
          done
          
          echo "::error::Health check timeout after ${{ env.HEALTH_CHECK_TIMEOUT }} seconds"
          argocd app get ${{ env.ARGOCD_APP_NAME }}
          echo "deployment_failed=true" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Get deployment details on failure
        if: failure() && steps.health_check.outputs.deployment_failed == 'true'
        run: |
          echo "=== Application Status ==="
          argocd app get ${{ env.ARGOCD_APP_NAME }}
          
          echo ""
          echo "=== Recent Events ==="
          argocd app get ${{ env.ARGOCD_APP_NAME }} -o json | jq -r '.status.conditions[]? | "[\(.type)] \(.message)"'
          
          echo ""
          echo "=== Resource Health ==="
          argocd app get ${{ env.ARGOCD_APP_NAME }} -o json | jq -r '.status.resources[]? | "\(.kind)/\(.name): \(.health.status // "Unknown")"'
      
      - name: Rollback on failure
        if: failure() && steps.health_check.outputs.deployment_failed == 'true'
        run: |
          echo "ðŸ”„ Health check failed - reverting Git commit..."
          
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the commit that triggered this workflow
          BAD_COMMIT=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B HEAD)
          
          echo "Reverting commit: $BAD_COMMIT"
          echo "Commit message: $COMMIT_MSG"
          
          # Check if this is a merge commit
          PARENT_COUNT=$(git cat-file -p HEAD | grep "^parent" | wc -l)
          
          if [ "$PARENT_COUNT" -gt 1 ]; then
            echo "This is a merge commit with $PARENT_COUNT parents"
            echo "Reverting merge commit (keeping first parent)..."
            git revert HEAD --no-edit -m 1
          else
            echo "This is a regular commit"
            git revert HEAD --no-edit
          fi
          
          # Push the revert
          git push origin main
          
          echo "Git rollback completed - ArgoCD will auto-sync to previous version"
          
          # Trigger immediate sync to speed up rollback
          argocd app sync ${{ env.ARGOCD_APP_NAME }} --prune
      
      - name: Notify on failure
        if: failure()
        run: |
          if [ "${{ steps.health_check.outputs.deployment_failed }}" = "true" ]; then
            echo "::error::Deployment failed health check and was automatically rolled back"
          else
            echo "::error::Workflow failed during setup or verification"
          fi
      
      - name: Notify on success
        if: success()
        run: |
          echo "::notice::âœ… Deployment verified successfully - application is healthy"
